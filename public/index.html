<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Control Video App</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { color: #667eea; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { color: #666; margin-bottom: 30px; }
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .upload-box { border: 3px dashed #667eea; border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-box:hover { background: #f8f9ff; border-color: #764ba2; }
        .upload-box input { display: none; }
        .upload-icon { font-size: 3em; margin-bottom: 10px; }
        .preview { max-width: 100%; max-height: 200px; margin-top: 15px; border-radius: 10px; }
        .prompt-section { margin-bottom: 30px; }
        textarea { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; resize: vertical; min-height: 80px; }
        .button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.1em; cursor: pointer; transition: transform 0.2s; font-weight: bold; }
        .button:hover { transform: scale(1.05); }
        .button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .result-section { margin-top: 40px; }
        .status { padding: 20px; background: #f8f9ff; border-radius: 10px; margin-bottom: 20px; font-size: 1.1em; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        video { width: 100%; max-width: 800px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .hidden { display: none; }
        .error { color: #e74c3c; background: #ffeaea; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Motion Control Video App</h1>
        <p class="subtitle">Transfer motion from reference videos to character images</p>
        
        <div class="upload-section">
            <label class="upload-box" for="imageUpload">
                <div class="upload-icon">üñºÔ∏è</div>
                <h3>Character Image</h3>
                <p>Click to upload your character</p>
                <input type="file" id="imageUpload" accept="image/*">
                <img id="imagePreview" class="preview hidden">
            </label>
            
            <label class="upload-box" for="videoUpload">
                <div class="upload-icon">üé•</div>
                <h3>Motion Reference Video</h3>
                <p>Click to upload motion</p>
                <input type="file" id="videoUpload" accept="video/*">
                <video id="videoPreview" class="preview hidden" controls></video>
            </label>
        </div>
        
        <div class="prompt-section">
            <h3>Scene Description (Optional)</h3>
            <textarea id="prompt" placeholder="Describe the style, environment, or mood... e.g., 'cinematic lighting, outdoor park scene'" ></textarea>
        </div>
        
        <button class="button" id="generateBtn" onclick="generateVideo()">Generate Video</button>
        
        <div id="error" class="error hidden"></div>
        
        <div id="result" class="result-section hidden">
            <div id="status" class="status"></div>
            <video id="resultVideo" class="hidden" controls></video>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let imageFile, videoFile, imageUrl, videoUrl;

        document.getElementById('imageUpload').addEventListener('change', function(e) {
            imageFile = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            preview.src = URL.createObjectURL(imageFile);
            preview.classList.remove('hidden');
        });

        document.getElementById('videoUpload').addEventListener('change', function(e) {
            videoFile = e.target.files[0];
            const preview = document.getElementById('videoPreview');
            preview.src = URL.createObjectURL(videoFile);
            preview.classList.remove('hidden');
        });

        async function uploadFile(file, endpoint) {
            const formData = new FormData();
            formData.append(endpoint === '/api/upload/image' ? 'image' : 'video', file);
            const response = await fetch(API_BASE + endpoint, { method: 'POST', body: formData });
            if (!response.ok) throw new Error('Upload failed');
            return await response.json();
        }

        async function generateVideo() {
            const errorEl = document.getElementById('error');
            const resultEl = document.getElementById('result');
            const statusEl = document.getElementById('status');
            const generateBtn = document.getElementById('generateBtn');
            
            errorEl.classList.add('hidden');
            resultEl.classList.remove('hidden');
            document.getElementById('resultVideo').classList.add('hidden');
            generateBtn.disabled = true;

            try {
                if (!imageFile || !videoFile) {
                    throw new Error('Please upload both character image and motion video');
                }

                statusEl.innerHTML = '<div class="spinner"></div> Uploading files...';
                
                const [imageResult, videoResult] = await Promise.all([
                    uploadFile(imageFile, '/api/upload/image'),
                    uploadFile(videoFile, '/api/upload/video')
                ]);

                imageUrl = imageResult.url;
                videoUrl = videoResult.url;

                statusEl.innerHTML = '<div class="spinner"></div> Starting video generation...';
                
                const prompt = document.getElementById('prompt').value;
                const response = await fetch(API_BASE + '/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ characterImageUrl: imageUrl, motionVideoUrl: videoUrl, prompt })
                });

                if (!response.ok) throw new Error('Generation failed');
                const data = await response.json();
                
                statusEl.innerHTML = '<div class="spinner"></div> Processing motion transfer... This may take 2-5 minutes.';
                checkStatus(data.jobId);
                
            } catch (error) {
                errorEl.textContent = '‚ùå Error: ' + error.message;
                errorEl.classList.remove('hidden');
                resultEl.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }

        async function checkStatus(jobId) {
            const statusEl = document.getElementById('status');
            const videoEl = document.getElementById('resultVideo');
            const generateBtn = document.getElementById('generateBtn');
            
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(API_BASE + '/api/status/' + jobId);
                    const data = await response.json();
                    
                    if (data.status === 'succeeded') {
                        clearInterval(interval);
                        statusEl.innerHTML = '‚úÖ Video generation complete!';
                        videoEl.src = data.videoUrl;
                        videoEl.classList.remove('hidden');
                        generateBtn.disabled = false;
                    } else if (data.status === 'failed') {
                        clearInterval(interval);
                        statusEl.innerHTML = '‚ùå Generation failed: ' + (data.error || 'Unknown error');
                        generateBtn.disabled = false;
                    } else {
                        statusEl.innerHTML = '<div class="spinner"></div> Processing... Status: ' + data.status;
                    }
                } catch (error) {
                    clearInterval(interval);
                    statusEl.innerHTML = '‚ùå Error checking status: ' + error.message;
                    generateBtn.disabled = false;
                }
            }, 3000);
        }
    </script>
</body>
</html>
